removeStrategy:
  items: "none"
  rbac: "sync"

items:

  # =====================================================
  # Shared Kubernetes Cloud (Shared Agents)
  # =====================================================
  - kind: sharedCloud
    name: "shared-k8s-cloud"
    displayName: "Shared Kubernetes Cloud"
    description: "Shared Kubernetes agents for all managed controllers"
    takeOnline: true

    properties:
      - sharedCloud: {}

    cloud:
      kubernetes:
        name: "shared-k8s"
        serverUrl: "https://kubernetes.default.svc"
        namespace: "cloudbees-builds"
        jenkinsUrl: "http://cjoc.cloudbees.svc.cluster.local/cjoc"
        containerCap: 50
        skipTlsVerify: true

        templates:
          - name: "devops-agent"
            label: "devops-agent"
            namespace: "cloudbees-builds"
            serviceAccount: "jenkins-agents"

            imagePullSecrets:
              - name: dockerhub-creds

            volumes:
              - name: workspace-volume
                emptyDir: {}
              - name: build-cache
                emptyDir: {}

            containers:
              # =========================
              # JNLP (Jenkins Agent)
              # =========================
              - name: jnlp
                image: kamalakar2210/devops_image:latest
                imagePullPolicy: IfNotPresent
                workingDir: /home/jenkins/agent
                ttyEnabled: true

                volumeMounts:
                  - name: workspace-volume
                    mountPath: /home/jenkins/agent
                  - name: build-cache
                    mountPath: /cache

                resources:
                  requests:
                    cpu: "500m"
                    memory: "1Gi"
                  limits:
                    cpu: "1"
                    memory: "2Gi"

  # =====================================================
  # Managed Controller
  # =====================================================
  - kind: managedController
    name: "managed-controller-alpha"
    displayName: "Managed Controller Alpha"
    description: "Managed controller using shared Kubernetes agents"

    properties:
      - configurationAsCode:
          bundle: controller-bundle
      - sharedConfigurationOptOut:
          optOut: false
      - healthReporting:
          enabled: false
      - licensing:
          strategy:
            perUserLicensingStrategy: {}

    configuration:
      kubernetes:
        memory: 4096
        cpus: 2
        disk: 50
        fsGroup: "1000"
        terminationGracePeriodSeconds: 600
        allowExternalAgents: false
        clusterEndpointId: default

